name: Bybit News Monitor

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Restore dependencies
        working-directory: ./ByBitNewListingsApp
        run: dotnet restore
      
      - name: Restore cached state
        uses: actions/cache/restore@v3
        continue-on-error: true
        with:
          path: ByBitNewListingsApp/seen_news.json
          key: bybit-news-state
      
      - name: Create initial state file if not exists
        working-directory: ./ByBitNewListingsApp
        run: |
          if [ ! -f seen_news.json ]; then
            echo "[]" > seen_news.json
            echo "Created new seen_news.json file"
          else
            echo "Restored existing seen_news.json file"
            cat seen_news.json
          fi
      
      - name: Run News Monitor
        working-directory: ./ByBitNewListingsApp
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          LOCALE: 'en-US'
          CHECK_INTERVAL_SECONDS: '60'
        run: |
          timeout 4m dotnet run || true
      
      - name: Display updated state
        if: always()
        working-directory: ./ByBitNewListingsApp
        run: |
          echo "Updated state file:"
          cat seen_news.json || echo "File not found"
      
      - name: Delete old cache
        if: always()
        continue-on-error: true
        run: |
          gh cache delete "bybit-news-state" --confirm || echo "No cache to delete"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Save state to cache
        if: always()
        uses: actions/cache/save@v3
        with:
          path: ByBitNewListingsApp/seen_news.json
          key: bybit-news-state
